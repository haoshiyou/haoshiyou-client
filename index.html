<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

    <!-- Start of Google Analytics -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-55311687-1', 'auto');
        ga('require', 'displayfeatures');
        ga('send', 'pageview');

    </script>
    <!-- End of Google Analytics -->

    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="font-awesome-4.2.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="col-xs-12 col-sm-6 col-sm-offset-3 col-md-4 col-md-offset-4 col-lg-4 col-lg-offset-4" >
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">湾区租房互助群</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-nav navbar-right">
                <li><a href="http://rent-result.zzn.im">看表 <i class="fa fa-eye"></i></a></li>
                <li><a href="http://rent-form.zzn.im">填表 <i class="fa fa-plus"></i></a></li>
                <li><a id="refresh_btn" href="#">刷新 <i class="fa fa-refresh"></i></a></li>
            </ul>
        </div><!--/.nav-collapse -->
        </div>
    </div><!--/.container-fluid -->
</div>
<div class="height-60px"></div>
<div class="container">
    <div class="outwrapper">
    <div class="col-xs-12 col-sm-6 col-sm-offset-3 col-md-4 col-md-offset-4 col-lg-4 col-lg-offset-4" id="value_panel_parent">
        <div class="panel" id="value_panel_template" style="display: none">
            <!-- Default panel contents -->
            <div class="panel-heading">
                <span><i class="fa fa-crosshairs"></i> </span>
                <span id="value_xq" class="zzn-content"></span>
                <span class="pull-right"><a id="row_link" href=""><i class="fa fa-link"></i></a></span>
            </div>
            <table class="table ">
                <tr class="detail">
                    <td><i class="fa fa-clock-o"></i> 发布时间</td>
                    <td id="value_fbsj" class="zzn-content"></td>
                </tr>
                <tr>
                    <td><i class="fa fa-clock-o"></i> 起始时间</td>
                    <td id="value_qssj" class="zzn-content"></td>
                </tr>
                <tr class="detail">
                    <td><i class="fa fa-clock-o"></i> 短租长租</td>
                    <td id="value_stlt" class="zzn-content"></td>
                </tr>
                <tr>
                    <td><i class="fa fa-location-arrow"></i> 位置</td>
                    <td id="value_wz" class="zzn-content"></td>
                </tr>
                <tr>
                    <td><i class="fa fa-calculator"></i> 预期价格</td>
                    <td id="value_yqjg" class="zzn-content"></td>
                </tr>
                <tr class="detail">
                    <td><i class="fa fa-child"></i> 性别</td>
                    <td id="value_xb" class="zzn-content"></td>
                </tr>
                <tr class="detail">
                    <td ><i class="fa fa-weixin"></i> 微信号</td>
                    <td class="zzn-content">
                        <span id="value_wxId"> </span>
                        <button class="btn btn-success btn-xs" id="btn_show_wxId">显示 <i class="glyphicon glyphicon-eye-open"></i></button>
                    </td>
                </tr>
                <tr class="detail">
                    <td><i class="fa fa-mail-forward"></i> 电话邮箱</td>
                    <td class="zzn-content">
                        <span id="value_dhyx"></span>
                        <button class="btn btn-success btn-xs" id="btn_show_dhyx">显示 <i class="glyphicon glyphicon-eye-open"></i></button>
                    </td>
                </tr>
                <tr class="detail">
                    <td colspan="2"><i class="fa fa-user"></i> 个人介绍</td>
                </tr>
                <tr class="detail">
                    <td  colspan="2">
                        <p><span id="value_grjs"></span></p>
                    </td>
                </tr>
            </table>
            <div class="panel-footer">
                <span class="zzn-panel-footer-button" data-toggle="modal" data-target="#notReadyModal"><i class="fa fa-share-alt"></i></span>
                <span class="zzn-panel-footer-button" data-toggle="modal" data-target="#notReadyModal"><i class="fa fa-thumbs-up"></i></span>
                <span class="zzn-panel-footer-button" data-toggle="modal" data-target="#notReadyModal"><i class="fa fa-bookmark"></i></span>
                <button class="btn btn-primary btn-xs pull-right" id="btn_show_detail"><i class="fa fa-dashboard"></i> 详细信息</button>
            </div>
        </div>

    </div>
    <div id="loading_panel" class="col-xs-12 col-sm-6 col-sm-offset-3 col-md-4 col-md-offset-4 col-lg-4 col-lg-offset-4" style="text-align: center" id="loading_indicator">
        <img src="ajax-loader.gif" alt="Loading..."/>
    </div>
    </div>
</div>

<div class="height-100px"></div>
<nav class="navbar navbar-default navbar-fixed-bottom" role="navigation">
    <div class="container">
        <div class="col-xs-12 col-sm-6 col-sm-offset-3 col-md-4 col-md-offset-4 col-lg-4 col-lg-offset-4" >
            <div class="navbar-header pull-right">
                    <a class="navbar-brand" href="group-qrcode.jpg">加入微信群 <i class="fa fa-qrcode"></i></a>
                    <a class="navbar-brand" href="https://www.linkedin.com/in/zainanvictorzhou/">Zainan Zhou <i class="fa fa-linkedin-square"></i></a>

            </div>
        </div>
    </div>
</nav>
<!-- Modal -->
<div class="modal fade" id="notReadyModal" tabindex="-1" role="dialog" aria-labelledby="notReadyModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel"><i class="fa fa-paint-brush"></i> 敬请期待</h4>
            </div>
            <div class="modal-body">
                <p>功能尚在开发中，请过两天再次查看 ：）</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script src="jquery-2.1.1.min.js"></script>
<script src="jquery.cookie.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="notify.min.js"></script>
<script src="purl.js"></script>
<script src="//www.parsecdn.com/js/parse-1.3.0.min.js"></script>
<script src="guid.js"></script>
<script src="zHelper.js"></script>
<script src="WeixinApi.js"></script>
<script src="weixin.js"></script>
<!-- Start of Woopra Code -->
<script>
    (function () {
        var t, i, e, n = window, o = document, a = arguments, s = "script", r = ["config", "track", "identify", "visit", "push", "call", "trackForm", "trackClick"], c = function () {
            var t, i = this;
            for (i._e = [], t = 0; r.length > t; t++)(function (t) {
                i[t] = function () {
                    return i._e.push([t].concat(Array.prototype.slice.call(arguments, 0))), i
                }
            })(r[t])
        };
        for (n._w = n._w || {}, t = 0; a.length > t; t++)n._w[a[t]] = n[a[t]] = n[a[t]] || new c;
        i = o.createElement(s), i.async = 1, i.src = "//static.woopra.com/js/w.js", e = o.getElementsByTagName(s)[0], e.parentNode.insertBefore(i, e)
    })("woopra");

    woopra.config({
        domain: 'rent.zzn.im'
    });

    woopra.track();
</script>
<!-- End of Woopra Code -->

<script>
    jQuery(function ($) {
        $(document).ready(function () {
            var template = $("#value_panel_template").clone();
            var parent = $("#value_panel_parent").empty();
            Parse.initialize("RPjt04MBMl3rzzEKBGKUpP7KHFXAsomtDbr9cS0y", "DSqWg9xElC6mI1PwtPWzzeIPQYUXPGTOC66nT82h");
            zHelper.trackerFunctions["woopra"] = function(action, dimensions) {
                woopra.track(action, dimensions);
            };
            zHelper.trackerFunctions["ga"] = function(action, dimensions) {
                ga('send', 'event', 'button', 'click', action, dimensions);
            };
            zHelper.trackerFunctions["ga"] = function(action, dimensions) {
                ga('send', 'event', 'button', 'click', action, dimensions);
            };
            zHelper.trackerFunctions["parse"] = function(action, dimensions) {
                var ParseTracking = Parse.Object.extend("ParseTracking");
                var parseTracking = new ParseTracking();
                for(var key in dimensions) {
                    parseTracking.set(key, dimensions[key]);
                }
                parseTracking.save();
            };
            zHelper.loggerFunctions["parse"] = function(msg, level, data) {
                var ParseLogging = Parse.Object.extend("ParseLogging");
                var parseLogging = new ParseLogging();
                parseLogging.set("msg", msg);
                parseLogging.set("level", level);
                for(var key in data) {
                    parseLogging.set(key, data[key]);
                }
                parseLogging.save();
            };
            // Init view
            zHelper.log("track view");
            zHelper.track("view");

            $.getJSON("http://www.telize.com/geoip?callback=?",
                    function (jsonp) {
                        zHelper.geoInfo.ip = jsonp.ip;
                        zHelper.geoInfo.city = jsonp.city;
                        zHelper.geoInfo.country = jsonp.country;
                        zHelper.track("loaded-geo-info");
                    }
            );

            // Set up cors proxy for jQuery
            $.ajaxPrefilter(function(options) {
                if(options.crossDomain && jQuery.support.cors) {
                    var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
                    options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
                    //options.url = "http://cors.corsproxy.io/url=" + options.url;
                }
            });
            var url = "https://spreadsheets.google.com/feeds/list/1vzugrYLpgXmFODqysSx331Lhq8LpDQGJ4sQtwSMrtV4/1/public/values?alt=json";
            var columns = {
              xq: "gsx$需求类别",
              qssj: "gsx$预计起始日期超过这个日期本条信息失效",
              wz: "gsx$位置",
              yqjg: "gsx$预期价格美元每月",
              grjs: "gsx$租房需求介绍和自我介绍",
              wxId: "gsx$微信号",
              xb: "gsx$性别",
              dhyx: "gsx$其他联系方式电话邮箱等",
              fbsj: "gsx$timestamp",
              ltst: "gsx$shorttermorlongterm"
            };

            var refreshPage = function(data){
                var pageRow = parseInt($.url().param("row"));
                var getCell = function(row, col) {
                    return data.feed.entry[row][columns[col]]["$t"] || "N/A";
                };
                var createChild = function(row) {
                    var child = template.clone();
                    var xq = data.feed.entry[row][columns["xq"]]["$t"];
                    child.find("#value_wxId").hide();
                    child.find("#value_dhyx").hide();

                    child.find(".detail").hide();


                    for (var col in columns) {
                        child.find("#value_" + col).text(getCell(row, col));

                    }
                    if (xq == "出租") {
                        child.addClass("panel-success");
                    } else if (xq == "求租") {
                        child.addClass("panel-primary");
                    } else if (xq == "找室友") {
                        child.addClass("panel-warning");
                    }
                    child.find("#value_wxId").hide();
                    child.find("#btn_show_wxId").click(function(){
                        child.find("#btn_show_wxId").hide();
                        child.find("#value_wxId").show();
                        zHelper.track("show-wechat-id", {pageRow: pageRow});
                    });
                    child.find("#btn_show_dhyx").click(function(){
                        child.find("#btn_show_dhyx").hide();
                        child.find("#value_dhyx").show();
                        zHelper.track("show-dhyx", {pageRow: pageRow});
                    });
                    child.find("#btn_show_detail").click(function(){
                        child.find("#btn_show_detail").hide();
                        child.find(".detail").show();
                        zHelper.track("show-detail", {pageRow: pageRow});
                    });
                    var rowLink = $.url().attr("path") + "?" + $.param($.extend($.url().param(), {"row": row}));
                    child.find("#row_link").attr("href", rowLink);
                    child.show();
                    return child;
                };
                if (!parseInt($.url().param("row"))) {
                    var dataLength = data.feed.entry.length;
                    for (var i = dataLength - 1; i >= 0; i--) {
                        var child = createChild(i);
                        parent.append(child);
                    }
                } else {
                    var child = createChild(pageRow);
                    parent.append(child);
                    var rowLink = $.url().attr("source");
                    zHelper.log("sharing " + rowLink);
                    weixin.wxData.link = rowLink;
                    weixin.wxData.title = getCell(pageRow, "xq") + "-" + getCell(pageRow, "wz");
                    weixin.wxData.desc = "起始时间:" + getCell(pageRow, "qssj") + ",预期价格" + getCell(pageRow, "yqjg");
                    weixin.wxCallbacks.confirm = function() {
                        zHelper.log("分享成功", "INFO", rowLink);
                        $.notify("分享成功", "success");
                    };
                    weixin.wxCallbacks.fail = function() {
                        zHelper.log("分享失败", "WARNING", rowLink);
                        $.notify("分享失败", "danger");
                    };
                }
            };
            var row = 1;
            parent.empty();
            $("#loading_panel").show();
            var cachedData = JSON.parse(localStorage.getItem("GoogleSheetData"));
            if (typeof cachedData === "undefined" || cachedData == null) {
                zHelper.log("cache missed, loading data...");

                $.get(url, function(data) {
                    zHelper.log("loaded data from CORS proxy");
                    localStorage.setItem("GoogleSheetData", JSON.stringify(data));
                    refreshPage(data);
                });
            } else {
                zHelper.log("using cached data");
                refreshPage(cachedData);
            }
            $("#loading_panel").hide();
            $("#refresh_btn").click(function() {
                zHelper.log("force fetch new data");
                parent.empty();
                $("#loading_panel").show();
                $.get(url, function(data) {
                    zHelper.log("loaded data from CORS proxy");
                    localStorage.setItem("GoogleSheetData", JSON.stringify(data));
                    setInterval(function(){
                        refreshPage(data);
                        $("#loading_panel").hide();
                    },500);
                });
            });
        });
    });
</script>

<!-- Google Tag Manager -->
<noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-PVD5TJ"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<script>(function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
    var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
    j.async = true;
    j.src =
            '//www.googletagmanager.com/gtm.js?id=' + i + dl;
    f.parentNode.insertBefore(j, f);
})(window, document, 'script', 'dataLayer', 'GTM-PVD5TJ');</script>
<!-- End Google Tag Manager -->

</body>
</html>